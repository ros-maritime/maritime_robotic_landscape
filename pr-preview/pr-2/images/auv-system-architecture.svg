<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 700" width="1000" height="700">
  <!-- Title -->
  <text x="500" y="30" font-size="22" font-weight="bold" text-anchor="middle" fill="#1e88e5">
    AUV System Architecture - ROS 2 Data Flow
  </text>

  <!-- Sensor Layer -->
  <g id="sensors">
    <text x="50" y="70" font-size="16" font-weight="bold" fill="#ff6f00">Sensors</text>

    <!-- DVL -->
    <rect x="50" y="90" width="140" height="80" rx="5" fill="#ff8f00" stroke="#e65100" stroke-width="2"/>
    <text x="120" y="115" font-size="13" font-weight="bold" text-anchor="middle" fill="white">DVL</text>
    <text x="120" y="132" font-size="10" text-anchor="middle" fill="white">dvl_driver</text>
    <line x1="60" y1="145" x2="180" y2="145" stroke="white" stroke-width="1"/>
    <text x="70" y="157" font-size="9" fill="white">Topics:</text>
    <text x="70" y="167" font-size="8" fill="#fff9c4">dvl/velocity</text>

    <!-- IMU -->
    <rect x="220" y="90" width="140" height="80" rx="5" fill="#ff8f00" stroke="#e65100" stroke-width="2"/>
    <text x="290" y="115" font-size="13" font-weight="bold" text-anchor="middle" fill="white">IMU/INS</text>
    <text x="290" y="132" font-size="10" text-anchor="middle" fill="white">sbg_driver</text>
    <line x1="230" y1="145" x2="350" y2="145" stroke="white" stroke-width="1"/>
    <text x="240" y="157" font-size="9" fill="white">Topics:</text>
    <text x="240" y="167" font-size="8" fill="#fff9c4">imu/data</text>

    <!-- Depth -->
    <rect x="390" y="90" width="140" height="80" rx="5" fill="#ff8f00" stroke="#e65100" stroke-width="2"/>
    <text x="460" y="115" font-size="13" font-weight="bold" text-anchor="middle" fill="white">Depth Sensor</text>
    <text x="460" y="132" font-size="10" text-anchor="middle" fill="white">bar30_driver</text>
    <line x1="400" y1="145" x2="520" y2="145" stroke="white" stroke-width="1"/>
    <text x="410" y="157" font-size="9" fill="white">Topics:</text>
    <text x="410" y="167" font-size="8" fill="#fff9c4">depth</text>

    <!-- GPS (surface only) -->
    <rect x="560" y="90" width="140" height="80" rx="5" fill="#ff8f00" stroke="#e65100" stroke-width="2" opacity="0.5"/>
    <text x="630" y="115" font-size="13" font-weight="bold" text-anchor="middle" fill="white">GPS</text>
    <text x="630" y="132" font-size="10" text-anchor="middle" fill="white">ublox_gps</text>
    <line x1="570" y1="145" x2="690" y2="145" stroke="white" stroke-width="1"/>
    <text x="580" y="157" font-size="9" fill="white">Topics:</text>
    <text x="580" y="167" font-size="8" fill="#fff9c4">gps/fix</text>
    <text x="630" y="90" font-size="9" text-anchor="middle" fill="#f57c00">(surface only)</text>
  </g>

  <!-- State Estimation Layer -->
  <g id="state-estimation">
    <text x="50" y="220" font-size="16" font-weight="bold" fill="#43a047">State Estimation</text>

    <!-- robot_localization EKF -->
    <rect x="150" y="240" width="450" height="100" rx="5" fill="#66bb6a" stroke="#2e7d32" stroke-width="3"/>
    <text x="375" y="265" font-size="14" font-weight="bold" text-anchor="middle" fill="white">robot_localization (EKF)</text>
    <text x="375" y="283" font-size="11" text-anchor="middle" fill="white">Fuses DVL + IMU + Depth + GPS</text>
    <line x1="170" y1="295" x2="580" y2="295" stroke="white" stroke-width="1"/>
    <text x="180" y="308" font-size="9" fill="white">Subscribes: /dvl/velocity, /imu/data, /depth, /gps/fix</text>
    <text x="180" y="323" font-size="9" fill="white">Publishes: /odometry/filtered (nav_msgs/Odometry)</text>
    <text x="180" y="335" font-size="9" fill="white">Broadcasts: odom → base_link TF</text>

    <!-- Arrows from sensors to EKF -->
    <path d="M 120 170 L 120 270 L 150 270" stroke="#ff6f00" stroke-width="2" marker-end="url(#arrowOrange)"/>
    <path d="M 290 170 L 290 270 L 150 270" stroke="#ff6f00" stroke-width="2" marker-end="url(#arrowOrange)"/>
    <path d="M 460 170 L 460 270 L 600 270" stroke="#ff6f00" stroke-width="2" marker-end="url(#arrowOrange)"/>
    <path d="M 630 170 L 630 270 L 600 270" stroke="#ff6f00" stroke-width="2" marker-end="url(#arrowOrange)" opacity="0.5"/>
  </g>

  <!-- Autonomy Layer -->
  <g id="autonomy">
    <text x="50" y="390" font-size="16" font-weight="bold" fill="#1e88e5">Autonomy & Planning</text>

    <!-- Mission Planner -->
    <rect x="50" y="410" width="200" height="80" rx="5" fill="#42a5f5" stroke="#0d47a1" stroke-width="2"/>
    <text x="150" y="435" font-size="13" font-weight="bold" text-anchor="middle" fill="white">Mission Planner</text>
    <text x="150" y="452" font-size="10" text-anchor="middle" fill="white">blue_behaviors</text>
    <line x1="60" y1="462" x2="240" y2="462" stroke="white" stroke-width="1"/>
    <text x="70" y="475" font-size="9" fill="white">Publishes:</text>
    <text x="70" y="485" font-size="8" fill="#fff9c4">cmd_vel, waypoints</text>

    <!-- Navigation (Nav2 or custom) -->
    <rect x="280" y="410" width="200" height="80" rx="5" fill="#42a5f5" stroke="#0d47a1" stroke-width="2"/>
    <text x="380" y="435" font-size="13" font-weight="bold" text-anchor="middle" fill="white">Path Following</text>
    <text x="380" y="452" font-size="10" text-anchor="middle" fill="white">Nav2 / LOS guidance</text>
    <line x1="290" y1="462" x2="470" y2="462" stroke="white" stroke-width="1"/>
    <text x="300" y="475" font-size="9" fill="white">Publishes:</text>
    <text x="300" y="485" font-size="8" fill="#fff9c4">cmd_vel</text>

    <!-- Obstacle Avoidance -->
    <rect x="510" y="410" width="200" height="80" rx="5" fill="#42a5f5" stroke="#0d47a1" stroke-width="2" opacity="0.7"/>
    <text x="610" y="435" font-size="13" font-weight="bold" text-anchor="middle" fill="white">Obstacle Avoidance</text>
    <text x="610" y="452" font-size="10" text-anchor="middle" fill="white">Sonar-based (optional)</text>
    <line x1="520" y1="462" x2="700" y2="462" stroke="white" stroke-width="1"/>
    <text x="530" y="475" font-size="9" fill="white">Modifies:</text>
    <text x="530" y="485" font-size="8" fill="#fff9c4">cmd_vel</text>

    <!-- Arrow from state estimation -->
    <path d="M 375 340 L 375 410" stroke="#43a047" stroke-width="2" marker-end="url(#arrowGreen)"/>
    <text x="385" y="375" font-size="10" fill="#43a047">Pose feedback</text>
  </g>

  <!-- Control Layer -->
  <g id="control">
    <text x="50" y="540" font-size="16" font-weight="bold" fill="#7b1fa2">Control</text>

    <!-- PID Controllers -->
    <rect x="120" y="560" width="300" height="90" rx="5" fill="#9c27b0" stroke="#4a148c" stroke-width="2"/>
    <text x="270" y="585" font-size="13" font-weight="bold" text-anchor="middle" fill="white">PID Controllers</text>
    <text x="270" y="602" font-size="10" text-anchor="middle" fill="white">Heading, Depth, Velocity</text>
    <line x1="130" y1="612" x2="410" y2="612" stroke="white" stroke-width="1"/>
    <text x="140" y="625" font-size="9" fill="white">Subscribes: /cmd_vel, /odometry/filtered</text>
    <text x="140" y="640" font-size="9" fill="white">Publishes: /wrench (forces & torques)</text>

    <!-- Thrust Allocator -->
    <rect x="470" y="560" width="280" height="90" rx="5" fill="#9c27b0" stroke="#4a148c" stroke-width="2"/>
    <text x="610" y="585" font-size="13" font-weight="bold" text-anchor="middle" fill="white">Thrust Allocator</text>
    <text x="610" y="602" font-size="10" text-anchor="middle" fill="white">mvp_control (QP) or pseudo-inverse</text>
    <line x1="480" y1="612" x2="740" y2="612" stroke="white" stroke-width="1"/>
    <text x="490" y="625" font-size="9" fill="white">Subscribes: /wrench</text>
    <text x="490" y="640" font-size="9" fill="white">Publishes: /thruster_commands</text>

    <!-- Arrows from autonomy to control -->
    <path d="M 150 490 L 150 560" stroke="#1e88e5" stroke-width="2" marker-end="url(#arrowBlue)"/>
    <path d="M 380 490 L 300 560" stroke="#1e88e5" stroke-width="2" marker-end="url(#arrowBlue)"/>
    <path d="M 610 490 L 610 560" stroke="#1e88e5" stroke-width="2" marker-end="url(#arrowBlue)" opacity="0.7"/>

    <!-- Arrow between PID and allocator -->
    <path d="M 420 605 L 470 605" stroke="#ab47bc" stroke-width="3" marker-end="url(#arrowPurple)"/>
  </g>

  <!-- Actuator Layer -->
  <g id="actuators">
    <text x="50" y="690" font-size="16" font-weight="bold" fill="#424242">Actuators</text>

    <!-- Thruster Manager -->
    <rect x="320" y="665" width="380" height="25" rx="3" fill="#666" stroke="#424242" stroke-width="2"/>
    <text x="510" y="682" font-size="11" font-weight="bold" text-anchor="middle" fill="white">Thruster Interfaces (ros2_control or direct PWM)</text>

    <!-- Individual thrusters -->
    <rect x="330" y="695" width="50" height="5" rx="1" fill="#ff6f00"/>
    <text x="355" y="688" font-size="7" text-anchor="middle" fill="#666">T1</text>

    <rect x="390" y="695" width="50" height="5" rx="1" fill="#ff6f00"/>
    <text x="415" y="688" font-size="7" text-anchor="middle" fill="#666">T2</text>

    <rect x="450" y="695" width="50" height="5" rx="1" fill="#ff6f00"/>
    <text x="475" y="688" font-size="7" text-anchor="middle" fill="#666">T3</text>

    <rect x="510" y="695" width="50" height="5" rx="1" fill="#ff6f00"/>
    <text x="535" y="688" font-size="7" text-anchor="middle" fill="#666">T4</text>

    <rect x="570" y="695" width="50" height="5" rx="1" fill="#ff6f00"/>
    <text x="595" y="688" font-size="7" text-anchor="middle" fill="#666">T5</text>

    <rect x="630" y="695" width="50" height="5" rx="1" fill="#ff6f00"/>
    <text x="655" y="688" font-size="7" text-anchor="middle" fill="#666">T6</text>

    <!-- Arrow from allocator to thrusters -->
    <path d="M 610 650 L 510 665" stroke="#9c27b0" stroke-width="2" marker-end="url(#arrowPurple)"/>
  </g>

  <!-- Legend -->
  <g id="legend">
    <rect x="750" y="240" width="220" height="210" rx="5" fill="#f5f5f5" stroke="#666" stroke-width="2"/>
    <text x="860" y="265" font-size="13" font-weight="bold" text-anchor="middle" fill="#333">Data Flow Legend</text>

    <line x1="770" y1="285" x2="810" y2="285" stroke="#ff6f00" stroke-width="2" marker-end="url(#arrowOrange)"/>
    <text x="820" y="290" font-size="10" fill="#666">Sensor data</text>

    <line x1="770" y1="305" x2="810" y2="305" stroke="#43a047" stroke-width="2" marker-end="url(#arrowGreen)"/>
    <text x="820" y="310" font-size="10" fill="#666">State estimate</text>

    <line x1="770" y1="325" x2="810" y2="325" stroke="#1e88e5" stroke-width="2" marker-end="url(#arrowBlue)"/>
    <text x="820" y="330" font-size="10" fill="#666">Commands</text>

    <line x1="770" y1="345" x2="810" y2="345" stroke="#9c27b0" stroke-width="2" marker-end="url(#arrowPurple)"/>
    <text x="820" y="350" font-size="10" fill="#666">Control signals</text>

    <line x1="760" y1="365" x2="960" y2="365" stroke="#ccc" stroke-width="1"/>

    <text x="770" y="385" font-size="11" font-weight="bold" fill="#333">Key Points:</text>
    <text x="770" y="402" font-size="9" fill="#666">• EKF runs at 30 Hz</text>
    <text x="770" y="417" font-size="9" fill="#666">• Controllers at 10-20 Hz</text>
    <text x="770" y="432" font-size="9" fill="#666">• All in ROS 2 Jazzy/Humble</text>
  </g>

  <!-- Notes -->
  <rect x="750" y="470" width="220" height="170" rx="5" fill="#fff9c4" stroke="#f57c00" stroke-width="2"/>
  <text x="860" y="495" font-size="12" font-weight="bold" text-anchor="middle" fill="#f57c00">Common Variations</text>

  <text x="760" y="515" font-size="10" fill="#666">ASV (Surface):</text>
  <text x="770" y="530" font-size="9" fill="#666">• GPS instead of DVL</text>
  <text x="770" y="543" font-size="9" fill="#666">• Wind/wave disturbances</text>

  <text x="760" y="563" font-size="10" fill="#666">ROV (Tethered):</text>
  <text x="770" y="578" font-size="9" fill="#666">• Teleoperation instead</text>
  <text x="770" y="591" font-size="9" fill="#666">  of autonomy</text>
  <text x="770" y="604" font-size="9" fill="#666">• Real-time joystick input</text>

  <text x="760" y="624" font-size="10" fill="#666">Glider:</text>
  <text x="770" y="639" font-size="9" fill="#666">• Buoyancy actuator</text>
  <text x="770" y="652" font-size="9" fill="#666">• No thrusters</text>

  <!-- Arrow markers -->
  <defs>
    <marker id="arrowOrange" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
      <polygon points="0 0, 8 4, 0 8" fill="#ff6f00"/>
    </marker>
    <marker id="arrowGreen" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
      <polygon points="0 0, 8 4, 0 8" fill="#43a047"/>
    </marker>
    <marker id="arrowBlue" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
      <polygon points="0 0, 8 4, 0 8" fill="#1e88e5"/>
    </marker>
    <marker id="arrowPurple" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
      <polygon points="0 0, 8 4, 0 8" fill="#9c27b0"/>
    </marker>
  </defs>
</svg>
