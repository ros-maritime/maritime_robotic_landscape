<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Integration Examples - Maritime Robotics Landscape</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Integration Examples";
        var mkdocs_page_input_path = "integration_examples.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Maritime Robotics Landscape
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../getting_started/">Getting Started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../faq/">FAQ</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../glossary/">Glossary</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../vehicle_types/">Vehicle Types</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../autonomy_stacks/">Autonomy Stacks</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../simulation/">Simulation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../hardware/">Hardware</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../software/">Software</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../drivers/">Drivers</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../datasets/">Datasets</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../education_and_tutorials/">Education & Tutorials</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../events/">Events</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../expert_reference/">Expert Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operations/">Operations</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Integration Examples</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#reference-architectures">Reference Architectures</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#torpedo-auv-survey-vehicle">Torpedo AUV (Survey Vehicle)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#hovering-auvrov-inspection-platform">Hovering AUV/ROV (Inspection Platform)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#asv-surface-survey">ASV (Surface Survey)</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#launch-file-patterns">Launch File Patterns</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#basic-sensor-fusion-robot_localization">Basic Sensor Fusion (robot_localization)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#thrust-allocation-6-dof-rov">Thrust Allocation (6-DOF ROV)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#complete-auv-launch-example-skeleton">Complete AUV Launch Example (Skeleton)</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#tf-tree-configurations">TF Tree Configurations</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#standard-torpedo-auv">Standard Torpedo AUV</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#hovering-rov-with-manipulator">Hovering ROV with Manipulator</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#asv-surface-vehicle">ASV (Surface Vehicle)</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#message-flow-patterns">Message Flow Patterns</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#high-rate-sensor-fusion">High-Rate Sensor Fusion</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#control-loop-architecture">Control Loop Architecture</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#acoustic-communication-pattern">Acoustic Communication Pattern</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sensor-suite-timing">Sensor Suite Timing</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#recommended-synchronization">Recommended Synchronization</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#multi-sensor-synchronization-example">Multi-Sensor Synchronization Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#troubleshooting-integration-issues">Troubleshooting Integration Issues</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#tf-tree-debugging">TF Tree Debugging</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#ekf-divergence">EKF Divergence</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#thrust-allocation-saturation">Thrust Allocation Saturation</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#references">References</a>
    </li>
    </ul>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Maritime Robotics Landscape</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Integration Examples</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="integration-examples">Integration Examples</h1>
<p><strong>For experienced maritime roboticists.</strong> Practical reference architectures, launch file patterns, and integration configurations from proven deployments.</p>
<div class="admonition warning">
<p class="admonition-title">Adapt to Your System</p>
<p>The launch files and configurations shown here are <strong>illustrative examples</strong> based on common integration patterns. You MUST adapt them to your specific:</p>
<ul>
<li>Hardware configuration (sensor models, frame IDs, ports)</li>
<li>Vehicle dynamics (process noise, allocation matrices)</li>
<li>Mission requirements (update rates, sensor priorities)</li>
</ul>
<p>Test thoroughly in simulation before deploying to hardware. Incorrect parameters can cause instability or damage.</p>
</div>
<hr />
<h2 id="reference-architectures">Reference Architectures</h2>
<h3 id="torpedo-auv-survey-vehicle">Torpedo AUV (Survey Vehicle)</h3>
<p><strong>Typical configuration:</strong> Forward-only propulsion, surveying seafloor at constant altitude.</p>
<p><strong>Sensor Suite:</strong>
- DVL (bottom-track velocity + altitude)
- INS/IMU (orientation, angular velocity)
- Depth sensor (pressure-based)
- GPS (surface positioning)
- Optional: Sidescan sonar, cameras, CTD</p>
<p><strong>Software Stack:</strong></p>
<pre><code>GPS (surface) ──┐
DVL (velocity)  ├──&gt; robot_localization (EKF) ──&gt; nav_msgs/Odometry
IMU (attitude)  ─┤
Depth (z)    ────┘

Odometry ──&gt; Mission Planner ──&gt; PID Controller ──&gt; Thruster Commands
</code></pre>
<p><strong>Key Integration Points:</strong>
- EKF fuses DVL, IMU, depth continuously
- GPS updates only at surface (discontinuous)
- Mission planner uses fused odometry for waypoint following
- Single thruster allocation (1-DOF control in surge)</p>
<h3 id="hovering-auvrov-inspection-platform">Hovering AUV/ROV (Inspection Platform)</h3>
<p><strong>Typical configuration:</strong> 6-DOF control, station-keeping for close-range inspection.</p>
<p><strong>Sensor Suite:</strong>
- DVL (3-axis velocity)
- INS (6-DOF orientation)
- Depth sensor
- Cameras (mono or stereo)
- Lights
- Forward-looking sonar (obstacle detection)
- Optional: USBL beacon, manipulator</p>
<p><strong>Software Stack:</strong></p>
<pre><code>DVL ──────┐
INS ──────┼──&gt; robot_localization (EKF) ──&gt; Odometry
Depth ────┤
USBL ─────┘ (low rate)

Odometry ──&gt; 6-DOF Controller ──&gt; Thrust Allocation ──&gt; Thrusters

Cameras ──&gt; Vision Pipeline ──&gt; Object Detection ──&gt; Mission Supervisor
FLS ─────&gt; Obstacle Detection ─────────────────────┘
</code></pre>
<p><strong>Key Integration Points:</strong>
- Fuse DVL/INS at the native sensor rates
- USBL updates are low-rate and need outlier rejection
- Thrust allocation handles multi-thruster configurations
- Mission supervisor coordinates inspection behaviors</p>
<h3 id="asv-surface-survey">ASV (Surface Survey)</h3>
<p><strong>Typical configuration:</strong> Differential drive or twin-thruster, autonomous surface mapping.</p>
<p><strong>Sensor Suite:</strong>
- GPS (primary positioning)
- IMU (heading, orientation)
- Optional: DVL (current measurement), sonar, cameras</p>
<p><strong>Software Stack:</strong></p>
<pre><code>GPS ──────┐
IMU ──────┼──&gt; robot_localization (EKF) ──&gt; Odometry
DVL ──────┘ (if available)

Odometry ──&gt; Nav2 ──&gt; Differential Drive Controller ──&gt; Thrusters
                │
Sonar/Camera ───&gt; Costmap ──&gt; Path Planning
</code></pre>
<p><strong>Key Integration Points:</strong>
- Nav2 provides path planning and obstacle avoidance
- GPS sufficient for positioning (no DVL required)
- Wave/current compensation via DVL or modeling
- Costmap integration for dynamic obstacles</p>
<hr />
<h2 id="launch-file-patterns">Launch File Patterns</h2>
<h3 id="basic-sensor-fusion-robot_localization">Basic Sensor Fusion (robot_localization)</h3>
<p><strong>File:</strong> <code>config/ekf.yaml</code> (example structure)</p>
<pre><code class="language-yaml">ekf_filter_node:
  ros__parameters:
    frequency: &lt;imu_rate&gt;  # Set to your IMU rate
    sensor_timeout: &lt;sensor_timeout&gt;  # Set to your sensor cadence
    two_d_mode: false

    # Frame configuration
    map_frame: map
    odom_frame: odom
    base_link_frame: base_link
    world_frame: odom

    # DVL: Velocity in body frame
    odom0: /dvl/velocity
    odom0_config: [false, false, false,    # x, y, z position (DVL doesn't provide absolute position)
                   false, false, false,    # roll, pitch, yaw
                   true,  true,  true,     # x_dot, y_dot, z_dot (body-frame velocities)
                   false, false, false,    # roll_dot, pitch_dot, yaw_dot
                   false, false, false]    # x_ddot, y_ddot, z_ddot
    odom0_differential: false
    odom0_relative: false

    # IMU: Orientation and angular velocity
    imu0: /imu/data
    imu0_config: [false, false, false,     # x, y, z position
                  true,  true,  true,      # roll, pitch, yaw (orientation)
                  false, false, false,     # velocities
                  true,  true,  true,      # roll_dot, pitch_dot, yaw_dot (angular velocities)
                  false, false, false]     # accelerations
    imu0_differential: false
    imu0_relative: false
    imu0_remove_gravitational_acceleration: true

    # Depth sensor: Absolute z position
    pose0: /depth/pose
    pose0_config: [false, false, true,     # x, y, z (only z from depth)
                   false, false, false,    # orientations
                   false, false, false,    # velocities
                   false, false, false,    # angular velocities
                   false, false, false]    # accelerations
    pose0_differential: false

    # GPS (surface only): Absolute x, y position
    # Only enable when surfaced
    pose1: /gps/fix
    pose1_config: [true,  true,  false,    # x, y (lat/lon converted)
                   false, false, false,
                   false, false, false,
                   false, false, false,
                   false, false, false]

    # Process noise covariances: see robot_localization docs and tune for your vehicle
</code></pre>
<p><strong>Launch File:</strong> <code>launch/localization.launch.py</code></p>
<pre><code class="language-python">from launch import LaunchDescription
from launch_ros.actions import Node
from launch.actions import DeclareLaunchArgument
from launch.substitutions import LaunchConfiguration
from ament_index_python.packages import get_package_share_directory
import os

def generate_launch_description():
    pkg_share = get_package_share_directory('my_auv_package')
    ekf_config = os.path.join(pkg_share, 'config', 'ekf.yaml')

    return LaunchDescription([
        # DVL driver
        Node(
            package='your_dvl_driver',
            executable='dvl_node',
            name='dvl',
            parameters=[{'port': '/dev/ttyUSB0', 'frame_id': 'dvl_link'}],
            remappings=[('velocity', '/dvl/velocity')]
        ),

        # IMU driver
        Node(
            package='your_imu_driver',
            executable='imu_node',
            name='imu',
            parameters=[os.path.join(pkg_share, 'config', 'imu.yaml')],
            remappings=[('imu/data', '/imu/data')]
        ),

        # Depth sensor
        Node(
            package='your_depth_driver',
            executable='depth_node',
            name='depth',
            parameters=[{'port': '/dev/ttyUSB1', 'frame_id': 'depth_link'}],
            remappings=[('depth', '/depth/pose')]
        ),

        # EKF localization
        Node(
            package='robot_localization',
            executable='ekf_node',
            name='ekf_filter_node',
            parameters=[ekf_config],
            remappings=[('odometry/filtered', '/odometry/local')]
        ),
    ])
</code></pre>
<h3 id="thrust-allocation-6-dof-rov">Thrust Allocation (6-DOF ROV)</h3>
<p><strong>File:</strong> <code>config/thruster_allocation.yaml</code></p>
<pre><code class="language-yaml">thruster_manager:
  ros__parameters:
    # Thruster configuration matrix
    # Row 1-3: Linear forces (surge, sway, heave)
    # Row 4-6: Moments (roll, pitch, yaw)
    # Columns: One per thruster

    allocation_matrix: [
      # Fill with your vehicle's geometry and thrust directions.
    ]

    # Thruster limits
    max_thrust: &lt;max_thrust&gt;  # Set to your thruster limit
    min_thrust: &lt;min_thrust&gt;  # Set to your thruster limit

    # Saturation handling
    use_saturation: true
    saturation_method: &quot;quadratic_programming&quot;  # or &quot;pseudo_inverse&quot;
</code></pre>
<p><strong>Launch with MVP Control (QP-based):</strong></p>
<pre><code class="language-python">Node(
    package='mvp_control',
    executable='thruster_allocator',
    name='thruster_allocator',
    parameters=[
        {'config_file': os.path.join(pkg_share, 'config', 'thruster_config.yaml')}
    ],
    remappings=[
        ('desired_forces', '/control/wrench'),
        ('thruster_forces', '/thrusters/commands')
    ]
)
</code></pre>
<h3 id="complete-auv-launch-example-skeleton">Complete AUV Launch Example (Skeleton)</h3>
<pre><code class="language-python">from launch import LaunchDescription
from launch_ros.actions import Node
from launch.actions import IncludeLaunchDescription
from launch.launch_description_sources import PythonLaunchDescriptionSource
from ament_index_python.packages import get_package_share_directory
import os

def generate_launch_description():
    pkg_share = get_package_share_directory('my_auv')

    return LaunchDescription([
        # ============ SENSORS ============
        # DVL
        Node(
            package='your_dvl_driver',
            executable='dvl_node',
            name='dvl',
            parameters=[os.path.join(pkg_share, 'config', 'dvl.yaml')],
        ),

        # INS
        Node(
            package='your_ins_driver',
            executable='ins_node',
            name='ins',
            parameters=[os.path.join(pkg_share, 'config', 'ins.yaml')],
        ),

        # Depth
        Node(
            package='your_depth_driver',
            executable='depth_node',
            name='depth',
        ),

        # ============ LOCALIZATION ============
        Node(
            package='robot_localization',
            executable='ekf_node',
            name='ekf_local',
            parameters=[os.path.join(pkg_share, 'config', 'ekf_local.yaml')],
            remappings=[('odometry/filtered', '/odometry/local')],
        ),

        # ============ CONTROL ============
        # PID Controllers
        Node(
            package='your_controller_pkg',
            executable='controller_node',
            name='depth_controller',
            parameters=[os.path.join(pkg_share, 'config', 'depth_pid.yaml')],
            remappings=[
                ('state', '/odometry/local'),
                ('setpoint', '/control/depth_setpoint'),
                ('control_effort', '/control/depth_effort')
            ],
        ),

        Node(
            package='your_controller_pkg',
            executable='controller_node',
            name='heading_controller',
            parameters=[os.path.join(pkg_share, 'config', 'heading_pid.yaml')],
            remappings=[
                ('state', '/odometry/local'),
                ('setpoint', '/control/heading_setpoint'),
                ('control_effort', '/control/heading_effort')
            ],
        ),

        # Thrust allocation
        Node(
            package='your_control_pkg',
            executable='thruster_allocator',
            name='thrust_allocator',
            parameters=[os.path.join(pkg_share, 'config', 'thrusters.yaml')],
        ),

        # ============ AUTONOMY ============
        Node(
            package='my_auv',
            executable='mission_manager',
            name='mission_manager',
            parameters=[os.path.join(pkg_share, 'config', 'mission.yaml')],
        ),

        # ============ ACTUATORS ============
        Node(
            package='my_auv',
            executable='thruster_driver',
            name='thrusters',
            parameters=[{'serial_port': '/dev/ttyACM0'}],
        ),

        # ============ STATIC TRANSFORMS ============
        Node(
            package='tf2_ros',
            executable='static_transform_publisher',
            name='base_to_dvl',
            arguments=['0', '0', '0', '0', '0', '0', 'base_link', 'dvl_link']
        ),

        Node(
            package='tf2_ros',
            executable='static_transform_publisher',
            name='base_to_ins',
            arguments=['0', '0', '0', '0', '0', '0', 'base_link', 'ins_link']
        ),
    ])
</code></pre>
<hr />
<h2 id="tf-tree-configurations">TF Tree Configurations</h2>
<h3 id="standard-torpedo-auv">Standard Torpedo AUV</h3>
<pre><code>map (world-fixed, global reference, GPS-aligned)
 └─ odom (continuous but drifting, dead reckoning origin)
     └─ base_link (robot body center, origin of robot frame)
         ├─ dvl_link (DVL sensor, offset forward and down)
         ├─ ins_link (INS sensor, typically at CoG)
         ├─ depth_link (depth sensor location)
         ├─ camera_link (forward camera)
         ├─ sonar_link (sidescan or multibeam)
         └─ thruster_link (propeller location)
</code></pre>
<p><strong>Key transforms:</strong>
- <code>map → odom</code>: Updated by GPS fixes (discontinuous, only at surface)
- <code>odom → base_link</code>: Published by robot_localization (continuous, rate matches your configuration)
- <code>base_link → sensors</code>: Static transforms, defined in URDF or static_transform_publisher</p>
<p><strong>Configuration:</strong></p>
<pre><code class="language-xml">&lt;!-- URDF snippet --&gt;
&lt;joint name=&quot;base_to_dvl&quot; type=&quot;fixed&quot;&gt;
  &lt;parent link=&quot;base_link&quot;/&gt;
  &lt;child link=&quot;dvl_link&quot;/&gt;
  &lt;origin xyz=&quot;0.15 0 -0.10&quot; rpy=&quot;0 0 0&quot;/&gt;
&lt;/joint&gt;

&lt;joint name=&quot;base_to_ins&quot; type=&quot;fixed&quot;&gt;
  &lt;parent link=&quot;base_link&quot;/&gt;
  &lt;child link=&quot;ins_link&quot;/&gt;
  &lt;origin xyz=&quot;0.0 0.0 0.0&quot; rpy=&quot;0 0 0&quot;/&gt;
&lt;/joint&gt;
</code></pre>
<p><strong>Launch:</strong></p>
<pre><code class="language-python">Node(
    package='robot_state_publisher',
    executable='robot_state_publisher',
    parameters=[{'robot_description': urdf_content}]
)
</code></pre>
<h3 id="hovering-rov-with-manipulator">Hovering ROV with Manipulator</h3>
<pre><code>world (simulator or map frame)
 └─ odom
     └─ base_link
         ├─ dvl_link
         ├─ ins_link
         ├─ camera_front_link
         ├─ camera_down_link
         ├─ lights_link
         ├─ thruster_1_link
         ├─ thruster_2_link
         │  ... (additional thrusters as needed)
         └─ manipulator_base_link
             └─ manipulator_link_1
                 └─ manipulator_link_2
                     └─ gripper_link
</code></pre>
<p><strong>Dynamic transforms:</strong>
- Manipulator joints published by <code>joint_state_publisher</code> or <code>ros2_control</code>
- MoveIt uses these for inverse kinematics</p>
<h3 id="asv-surface-vehicle">ASV (Surface Vehicle)</h3>
<pre><code>map (UTM or local grid)
 └─ odom
     └─ base_link
         ├─ gps_link (antenna location, offset from CoG)
         ├─ imu_link (typically at base_link)
         ├─ camera_link
         ├─ lidar_link (if equipped)
         └─ sonar_link (multibeam or sidescan)
</code></pre>
<p><strong>GPS offset critical:</strong> GPS antenna not at robot center affects heading calculation in dual-GPS setups.</p>
<hr />
<h2 id="message-flow-patterns">Message Flow Patterns</h2>
<h3 id="high-rate-sensor-fusion">High-Rate Sensor Fusion</h3>
<p><strong>Sensor rates:</strong>
- Use the native sensor rates from your device manuals and driver settings</p>
<p><strong>EKF configuration:</strong></p>
<pre><code class="language-yaml"># High-frequency prediction from IMU
frequency: &lt;imu_rate&gt;  # Set to IMU rate

# DVL corrections at your configured DVL rate
# EKF interpolates between measurements

# USBL corrections are low rate
# Use large covariance, enable outlier rejection
</code></pre>
<p><strong>Timing critical:</strong>
- All sensors must have synchronized timestamps
- Use <code>message_filters::TimeSynchronizer</code> if needed for multi-sensor processing
- EKF handles asynchronous measurements internally</p>
<h3 id="control-loop-architecture">Control Loop Architecture</h3>
<p><strong>Cascaded control (common pattern):</strong></p>
<pre><code>Mission Planner (mission cadence)
    ↓ (desired waypoint)
Path Follower (path cadence)
    ↓ (desired velocity/heading)
Velocity Controller (controller cadence)
    ↓ (desired forces/torques)
Thrust Allocator (allocator cadence)
    ↓ (individual thruster commands)
Thruster Driver (driver cadence)
</code></pre>
<p><strong>Message types:</strong></p>
<pre><code>nav_msgs/Path → geometry_msgs/Twist → geometry_msgs/Wrench → std_msgs/Float64MultiArray
</code></pre>
<p><strong>Timing considerations:</strong>
- Control loop must run faster than vehicle dynamics
- Allocator should match control rate
- Actuator commands can be higher rate (reduces jitter)</p>
<h3 id="acoustic-communication-pattern">Acoustic Communication Pattern</h3>
<p><strong>Challenge:</strong> Very low bandwidth and high latency</p>
<p><strong>Message prioritization:</strong></p>
<pre><code class="language-python">class AcousticPublisher:
    def __init__(self):
        # High priority: Emergency commands, status
        self.emergency_queue = PriorityQueue()

        # Medium priority: Mission updates
        self.mission_queue = Queue()

        # Low priority: Diagnostics, logs
        self.diagnostic_queue = Queue()

    def send_next(self):
        if not self.emergency_queue.empty():
            return self.emergency_queue.get()
        elif not self.mission_queue.empty():
            return self.mission_queue.get()
        else:
            return self.diagnostic_queue.get()
</code></pre>
<p><strong>ros_acomms integration:</strong></p>
<pre><code class="language-python"># Vehicle side
Node(
    package='ros_acomms',
    executable='modem_driver',
    parameters=[{
        'modem_id': 1,
        'rate': 0,  # Placeholder; set per modem specification
        'vehicle_config': 'modem_config.yaml'
    }],
    remappings=[
        ('rx', '/acomms/received'),
        ('tx', '/acomms/transmit')
    ]
)

# Topside
Node(
    package='ros_acomms',
    executable='modem_driver',
    parameters=[{
        'modem_id': 2,
        'rate': 0  # Placeholder; set per modem specification
    }]
)
</code></pre>
<hr />
<h2 id="sensor-suite-timing">Sensor Suite Timing</h2>
<h3 id="recommended-synchronization">Recommended Synchronization</h3>
<p><strong>Method 1: Hardware timestamping</strong>
- Use PPS (Pulse Per Second) from GPS
- Distribute to all sensors via trigger line
- Sensors timestamp data with hardware clock</p>
<p><strong>Method 2: Software timestamping</strong>
- NTP or PTP time synchronization
- Sensors use system time
- Less accurate but simpler</p>
<p><strong>ROS 2 timing:</strong></p>
<pre><code class="language-python"># In sensor driver
msg.header.stamp = self.get_clock().now().to_msg()

# EKF uses message timestamps
# Ensure sensor drivers use ROS time, not wall time
</code></pre>
<h3 id="multi-sensor-synchronization-example">Multi-Sensor Synchronization Example</h3>
<pre><code class="language-python">from message_filters import ApproximateTimeSynchronizer, Subscriber

class MultiSensorFusion(Node):
    def __init__(self):
        super().__init__('sensor_fusion')

        # Subscribe to multiple sensors
        image_sub = Subscriber(self, Image, '/camera/image')
        sonar_sub = Subscriber(self, SonarImage, '/sonar/image')
        odom_sub = Subscriber(self, Odometry, '/odometry/local')

        # Synchronize within a configurable window
        sync = ApproximateTimeSynchronizer(
            [image_sub, sonar_sub, odom_sub],
            queue_size=10,
            slop=&lt;sync_tolerance_s&gt;  # Set to your tolerance
        )
        sync.registerCallback(self.sync_callback)

    def sync_callback(self, image_msg, sonar_msg, odom_msg):
        # Messages arrive within the configured tolerance
        # Process fused data
        pass
</code></pre>
<hr />
<h2 id="troubleshooting-integration-issues">Troubleshooting Integration Issues</h2>
<h3 id="tf-tree-debugging">TF Tree Debugging</h3>
<p><strong>Problem:</strong> "Could not find a connection between 'map' and 'base_link'"</p>
<p><strong>Debug:</strong></p>
<pre><code class="language-bash"># View full TF tree
ros2 run tf2_tools view_frames

# Check specific transform
ros2 run tf2_ros tf2_echo map base_link

# Monitor TF rates
ros2 topic hz /tf
ros2 topic hz /tf_static
</code></pre>
<p><strong>Common causes:</strong>
- Missing static transform
- Parent frame not published
- Circular dependency</p>
<h3 id="ekf-divergence">EKF Divergence</h3>
<p><strong>Symptoms:</strong>
- Position estimate jumps
- Covariance grows unbounded
- Innovation values very large</p>
<p><strong>Debug:</strong></p>
<pre><code class="language-bash"># Monitor EKF diagnostics
ros2 topic echo /diagnostics

# Check sensor rates
ros2 topic hz /dvl/velocity
ros2 topic hz /imu/data

# Verify timestamps
ros2 topic echo /dvl/velocity --field header.stamp
</code></pre>
<p><strong>Common fixes:</strong>
- Reduce sensor covariance (too confident in bad data)
- Increase process noise (model doesn't match reality)
- Check for timestamp errors (using wall time instead of ROS time)
- Disable problematic sensor temporarily</p>
<h3 id="thrust-allocation-saturation">Thrust Allocation Saturation</h3>
<p><strong>Symptoms:</strong>
- Vehicle can't maintain position
- Constant thruster saturation warnings
- Poor trajectory following</p>
<p><strong>Debug:</strong></p>
<pre><code class="language-python"># Monitor allocation output
ros2 topic echo /thruster_allocator/status

# Check desired vs. achievable forces
ros2 topic echo /control/wrench
ros2 topic echo /thrusters/forces
</code></pre>
<p><strong>Solutions:</strong>
- Reduce commanded velocities
- Improve vehicle buoyancy (reduce constant heave thrust requirement)
- Check allocation matrix condition number
- Add more thrusters or reposition existing ones</p>
<hr />
<h2 id="references">References</h2>
<ul>
<li><a href="https://docs.ros.org/en/melodic/api/robot_localization/html/">robot_localization documentation</a></li>
<li><a href="https://control.ros.org/">ros2_control documentation</a></li>
<li><a href="https://docs.nav2.org/">Nav2 documentation</a></li>
<li><a href="https://github.com/uri-ocean-robotics/mvp_readme">MVP project examples</a></li>
<li><a href="https://github.com/Robotic-Decision-Making-Lab/blue">Blue project launch files</a></li>
</ul>
<hr />
<p><em>This page was last updated: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">December 30, 2025</span></em></p>
<script data-goatcounter="https://maritime-robotics-landscape.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../operations/" class="btn btn-neutral float-left" title="Operations"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Information assembled by the ROS Maritime Robotics Working Group. Privacy-respecting analytics with GoatCounter.</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../operations/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
